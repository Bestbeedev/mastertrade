import{U as v,a as D,j as e,H as ne,b as ce,t as d}from"./app-B3Y0P8eL.js";import{A as de}from"./app-layout-BmrSMU7B.js";import{C as M,a as V,b as R,c as I,d as H}from"./card-B6WQ6knZ.js";import{B as j,s as _}from"./index-BS9Mkhtc.js";import{I as x}from"./input-B58C95N6.js";import{L as t}from"./label-Dhbczhvd.js";import{S as o,a as u,b as h,c as m,d as p}from"./select-CRiprpJX.js";import{T as xe,a as oe,b as O,c as B}from"./tabs-7x_I4q-o.js";import{T as ue,a as he,b as P,c as n,d as me,e as c,f as pe}from"./table-pRABPITF.js";import{D as U,a as q,b as z,c as Y,d as G}from"./dialog-DgY4hv6z.js";/* empty css            */import"./auth-ClV7ZO7P.js";import"./index-BJlpveyn.js";import"./index-DOpKAXXZ.js";import"./index-B7VOcpwy.js";import"./index-ChXgRNoH.js";import"./chevron-right-CR-mXq2c.js";import"./index-DN2tWQS9.js";import"./check-Dwe-_DrS.js";function Ve({licenses:C=[],products:S=[],users:T=[],filters:w={}}){const[Q,A]=v.useState("list"),[L,$]=v.useState(w.q??""),[E,J]=v.useState(w.status??""),[r,y]=v.useState(null),[g,f]=v.useState(null),K=s=>{if(!s)return null;const a=new Date,te=new Date(a.getFullYear(),a.getMonth(),a.getDate()),b=new Date(s),le=new Date(b.getFullYear(),b.getMonth(),b.getDate()),re=1440*60*1e3;return Math.round((le.getTime()-te.getTime())/re)},k=({date:s})=>{const a=K(s);return a===null?null:a<0?e.jsxs("span",{className:"text-xs text-destructive",children:["Expirée il y a ",Math.abs(a)," j"]}):a===0?e.jsx("span",{className:"text-xs text-amber-600",children:"Expire aujourd’hui"}):a<=30?e.jsxs("span",{className:"text-xs text-amber-600",children:["Reste ",a," j"]}):e.jsxs("span",{className:"text-xs text-emerald-600",children:["Reste ",a," j"]})},N=[{value:"all",label:"Tous"},{value:"active",label:"Actives"},{value:"expired",label:"Expirées"},{value:"inactive",label:"Inactives"}],F=[{value:"subscription",label:"Abonnement"},{value:"perpetual",label:"Perpétuelle"}],l=D({user_id:"",product_id:"",type:"subscription",status:"active",expiry_date:"",max_activations:1}),i=D({status:"",type:"",expiry_date:"",max_activations:"",user_id:"",product_id:"",regenerate_key:!1}),{delete:W,processing:X}=D({}),Z=s=>{s.preventDefault(),ce.get(_("admin.licenses"),{q:L,status:E},{preserveState:!0,replace:!0})},ee=s=>{s.preventDefault();const a=d.loading("Création de la licence...");l.post(_("admin.licenses.store"),{onSuccess:()=>{d.success("Licence créée",{id:a}),l.reset(),A("list")},onError:()=>d.error("Erreur lors de la création",{id:a})})},se=s=>{y(s),i.setData({status:s.status??"",type:s.type??"",expiry_date:s.expiry_date?new Date(s.expiry_date).toISOString().slice(0,10):"",max_activations:s.max_activations??"",user_id:s.user_id??"",product_id:s.product_id??"",regenerate_key:!1})},ae=s=>{if(s.preventDefault(),!r)return;const a=d.loading("Mise à jour de la licence...");i.patch(_("admin.licenses.update",{license:r.id}),{onSuccess:()=>{d.success("Licence mise à jour",{id:a}),y(null)},onError:()=>d.error("Erreur lors de la mise à jour",{id:a}),preserveScroll:!0})},ie=()=>{if(!g)return;const s=d.loading("Suppression de la licence..."),a=g.id;W(_("admin.licenses.destroy",{license:a}),{onSuccess:()=>{d.success("Licence supprimée",{id:s}),f(null)},onError:()=>d.error("Erreur lors de la suppression",{id:s}),preserveScroll:!0})};return e.jsxs(de,{breadcrumbs:[{title:"Admin",href:"/admin"},{title:"Licences",href:"/admin/licenses"}],children:[e.jsx(ne,{title:"Admin • Licences"}),e.jsxs("div",{className:"w-full px-4 sm:px-6 lg:px-8 py-6 space-y-6",children:[e.jsx("div",{className:"flex items-center justify-between",children:e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold tracking-tight",children:"Gestion des Licences"}),e.jsx("p",{className:"text-muted-foreground",children:"Créer, filtrer et administrer les licences"})]})}),e.jsxs(xe,{value:Q,onValueChange:A,className:"space-y-4",children:[e.jsxs(oe,{children:[e.jsx(O,{value:"list",children:"Liste"}),e.jsx(O,{value:"new",children:"Nouvelle"})]}),e.jsx(B,{value:"list",className:"space-y-4",children:e.jsxs(M,{children:[e.jsxs(V,{children:[e.jsx(R,{children:"Licences"}),e.jsx(I,{children:"Liste des licences"})]}),e.jsxs(H,{children:[e.jsxs("form",{onSubmit:Z,className:"flex items-center gap-2 mb-4",children:[e.jsx(x,{value:L,onChange:s=>$(s.target.value),placeholder:"Recherche clé, email ou produit"}),e.jsxs(o,{value:E,onValueChange:J,children:[e.jsx(u,{className:"w-40",children:e.jsx(h,{placeholder:"Statut"})}),e.jsx(m,{children:N.map(s=>e.jsx(p,{value:s.value,children:s.label},s.value))})]}),e.jsx(j,{type:"submit",variant:"outline",children:"Filtrer"})]}),e.jsx("div",{children:e.jsxs(ue,{children:[e.jsx(he,{children:e.jsxs(P,{children:[e.jsx(n,{children:"Clé"}),e.jsx(n,{children:"Produit"}),e.jsx(n,{children:"Utilisateur"}),e.jsx(n,{children:"Type"}),e.jsx(n,{children:"Statut"}),e.jsx(n,{children:"Expire"}),e.jsx(n,{children:"Activations"}),e.jsx(n,{children:"Device ID"}),e.jsx(n,{children:"Machine"}),e.jsx(n,{children:"Adresses MAC"}),e.jsx(n,{children:"Dernière activation"}),e.jsx(n,{children:"Actions"})]})}),e.jsx(me,{children:C.map(s=>e.jsxs(P,{children:[e.jsx(c,{className:"font-mono text-xs",children:s.key}),e.jsxs(c,{children:[s.product?.name??"—",s.product?.version?` • v${s.product.version}`:""]}),e.jsx(c,{children:s.user?.name??"—"}),e.jsx(c,{className:"uppercase text-xs",children:s.type}),e.jsx(c,{className:"uppercase text-xs",children:s.status}),e.jsx(c,{children:s.expiry_date?e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{children:new Date(s.expiry_date).toLocaleDateString("fr-FR")}),e.jsx(k,{date:s.expiry_date})]}):"—"}),e.jsxs(c,{children:[s.activations_count??0,"/",s.max_activations??1]}),e.jsx(c,{className:"font-mono text-xs",children:s.last_device_id??"—"}),e.jsx(c,{children:s.last_machine??"—"}),e.jsx(c,{className:"font-mono text-xs",children:Array.isArray(s.devices)&&s.devices.length>0?s.devices.slice(0,3).map(a=>a?.mac_address||a?.device_id||"—").filter(Boolean).join(" , "):s.last_mac_address??"—"}),e.jsx(c,{children:s.last_activated_at?new Date(s.last_activated_at).toLocaleString("fr-FR"):"—"}),e.jsxs(c,{className:"space-x-2",children:[e.jsx(j,{size:"sm",variant:"outline",onClick:()=>se(s),children:"Éditer"}),e.jsx(j,{size:"sm",variant:"destructive",onClick:()=>f(s),disabled:X,children:"Supprimer"})]})]},s.id))}),C.length===0&&e.jsx(pe,{children:"Aucune licence"})]})}),e.jsx(U,{open:!!g,onOpenChange:s=>{s||f(null)},children:e.jsxs(q,{children:[e.jsxs(z,{children:[e.jsx(Y,{children:"Confirmer la suppression"}),e.jsx(G,{children:"Êtes-vous sûr de vouloir supprimer cette licence ?"})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("p",{children:["Vous êtes sur le point de supprimer la licence ",g?.key,"."]}),e.jsxs("div",{className:"flex gap-2 justify-end",children:[e.jsx(j,{type:"button",variant:"ghost",onClick:()=>f(null),children:"Annuler"}),e.jsx(j,{type:"button",variant:"destructive",onClick:ie,children:"Supprimer"})]})]})]})}),e.jsx(U,{open:!!r,onOpenChange:s=>{s||y(null)},children:e.jsxs(q,{className:"max-w-4xl lg:max-w-6xl xl:max-w-7xl max-h-[90vh] overflow-y-auto",children:[e.jsxs(z,{children:[e.jsx(Y,{children:"Modifier la licence"}),e.jsx(G,{children:"Mettre à jour les informations de la licence sélectionnée."})]}),r&&e.jsxs("form",{onSubmit:ae,className:"space-y-3",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(t,{children:"Utilisateur"}),e.jsxs(o,{value:i.data.user_id||"",onValueChange:s=>i.setData("user_id",s),children:[e.jsx(u,{className:"w-full",children:e.jsx(h,{placeholder:"Sélectionner"})}),e.jsx(m,{children:T.map(s=>e.jsxs(p,{value:s.id,children:[s.name," (",s.email,")"]},s.id))})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(t,{children:"Produit"}),e.jsxs(o,{value:i.data.product_id||"",onValueChange:s=>i.setData("product_id",s),children:[e.jsx(u,{className:"w-full",children:e.jsx(h,{placeholder:"Sélectionner"})}),e.jsx(m,{children:S.map(s=>e.jsx(p,{value:s.id,children:s.name},s.id))})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(t,{children:"Type"}),e.jsxs(o,{value:i.data.type||"subscription",onValueChange:s=>i.setData("type",s),children:[e.jsx(u,{className:"w-full",children:e.jsx(h,{placeholder:"Type"})}),e.jsx(m,{children:F.map(s=>e.jsx(p,{value:s.value,children:s.label},s.value))})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(t,{children:"Statut"}),e.jsxs(o,{value:i.data.status||"active",onValueChange:s=>i.setData("status",s),children:[e.jsx(u,{className:"w-full",children:e.jsx(h,{placeholder:"Statut"})}),e.jsx(m,{children:N.filter(s=>s.value!=="all").map(s=>e.jsx(p,{value:s.value,children:s.label},s.value))})]})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(t,{htmlFor:"e_expiry",children:"Expiration"}),e.jsx(x,{id:"e_expiry",type:"date",value:i.data.expiry_date||"",onChange:s=>i.setData("expiry_date",s.target.value)}),i.data.expiry_date?e.jsx(k,{date:i.data.expiry_date}):null]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(t,{htmlFor:"e_max",children:"Max activations"}),e.jsx(x,{id:"e_max",type:"number",min:1,value:i.data.max_activations??"",onChange:s=>i.setData("max_activations",s.target.value)})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(t,{children:"Device ID (lecture seule)"}),e.jsx(x,{value:r.last_device_id??"—",disabled:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(t,{children:"Machine (lecture seule)"}),e.jsx(x,{value:r.last_machine??"—",disabled:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(t,{children:"Adresse MAC (lecture seule)"}),e.jsx(x,{value:r.last_mac_address??"—",disabled:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(t,{children:"Dernière activation (lecture seule)"}),e.jsx(x,{value:r.last_activated_at?new Date(r.last_activated_at).toLocaleString("fr-FR"):"—",disabled:!0})]}),e.jsxs("div",{className:"space-y-2 md:col-span-2",children:[e.jsx(t,{children:"Appareils enregistrés (lecture seule)"}),e.jsxs("div",{className:"text-xs space-y-1",children:[(Array.isArray(r.devices)?r.devices:[]).slice(0,3).map((s,a)=>e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsx("span",{className:"font-mono",children:s?.mac_address||"—"}),e.jsxs("span",{className:"text-muted-foreground",children:["(",s?.device_id||"—",")"]}),e.jsxs("span",{className:"text-muted-foreground",children:["• ",s?.machine||"—"]})]},a)),!Array.isArray(r.devices)||r.devices.length===0?e.jsx("div",{className:"text-muted-foreground",children:"—"}):null]})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{id:"regen",type:"checkbox",checked:!!i.data.regenerate_key,onChange:s=>i.setData("regenerate_key",s.target.checked),className:"h-4 w-4 rounded border-gray-300 text-primary focus:ring-primary"}),e.jsx(t,{htmlFor:"regen",children:"Régénérer la clé"})]}),e.jsxs("div",{className:"flex gap-2 justify-end",children:[e.jsx(j,{type:"button",variant:"ghost",onClick:()=>y(null),children:"Annuler"}),e.jsx(j,{type:"submit",children:"Enregistrer"})]})]})]})})]})]})}),e.jsx(B,{value:"new",children:e.jsx("form",{onSubmit:ee,children:e.jsxs(M,{children:[e.jsxs(V,{children:[e.jsx(R,{children:"Nouvelle licence"}),e.jsx(I,{children:"Créer une licence"})]}),e.jsxs(H,{className:"space-y-4",children:[e.jsxs("div",{className:"grid gap-4 md:grid-cols-2",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(t,{children:"Utilisateur"}),e.jsxs(o,{value:l.data.user_id||"",onValueChange:s=>l.setData("user_id",s),children:[e.jsx(u,{className:"w-full",children:e.jsx(h,{placeholder:"Sélectionner"})}),e.jsx(m,{children:T.map(s=>e.jsxs(p,{value:s.id,children:[s.name," (",s.email,")"]},s.id))})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(t,{children:"Produit"}),e.jsxs(o,{value:l.data.product_id||"",onValueChange:s=>l.setData("product_id",s),children:[e.jsx(u,{className:"w-full",children:e.jsx(h,{placeholder:"Sélectionner"})}),e.jsx(m,{children:S.map(s=>e.jsx(p,{value:s.id,children:s.name},s.id))})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(t,{children:"Type"}),e.jsxs(o,{value:l.data.type,onValueChange:s=>l.setData("type",s),children:[e.jsx(u,{className:"w-full",children:e.jsx(h,{placeholder:"Type"})}),e.jsx(m,{children:F.map(s=>e.jsx(p,{value:s.value,children:s.label},s.value))})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(t,{children:"Statut"}),e.jsxs(o,{value:l.data.status,onValueChange:s=>l.setData("status",s),children:[e.jsx(u,{className:"w-full",children:e.jsx(h,{placeholder:"Statut"})}),e.jsx(m,{children:N.filter(s=>s.value!=="").map(s=>e.jsx(p,{value:s.value,children:s.label},s.value))})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(t,{htmlFor:"c_expiry",children:"Expiration"}),e.jsx(x,{id:"c_expiry",type:"date",value:l.data.expiry_date,onChange:s=>l.setData("expiry_date",s.target.value)})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(t,{htmlFor:"c_max",children:"Max activations"}),e.jsx(x,{id:"c_max",type:"number",min:1,value:l.data.max_activations,onChange:s=>l.setData("max_activations",s.target.value)})]})]}),e.jsx("div",{className:"flex justify-end",children:e.jsx(j,{type:"submit",children:"Créer"})})]})]})})})]})]})]})}export{Ve as default};
